// This is your Prisma schema file
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Level {
  Basic
  Intermidate
  Advantage
}

model User {
  userId       String    @id @default(uuid())
  userName     String
  password     String
  email        String    @unique
  gender       Gender
  avatarURL    String?
  region       String?
  dateOfBirth  DateTime?
  level        Level?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  account            Account?             
  accountId          String?
  roles              UserRole[]
  roleClaims         RoleClaim[]           
  coursesCreated     Course[]              
  comments           Comment[]
  payments           Payment[]
  certificates       Certificate[]
  notifications      Notification[]
  userCoursePreviews UserCoursePreview[]
  submissions        Submission[]
  lessonsProgress    UserLessonProgress[]
}

model Account {
  id                String   @id @default(uuid())
  userId            String
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Role {
  roleId   String    @id @default(uuid())
  name     String

  userRoles UserRole[]
  roleClaims RoleClaim[]
}

model UserRole {
  id     String @id @default(uuid())
  userId String
  roleId String

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@unique([userId, roleId])
}

model RoleClaim {
  roleClaimId String @id @default(uuid())
  roleId      String?
  roleName    String?
  permission  String
  claimType   String?
  claimValue  String?

  role Role? @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
}

model Course {
  courseId          String   @id @default(uuid())
  courseName        String
  courseDescription String?
  coursePrice       Float
  discount          Float?
  avatarURL         String?
  level             Level?
  createdBy         String?   
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt

  user        User?      @relation(fields: [createdBy], references: [userId], onDelete: SetNull)
  chapters    Chapter[]
  comments    Comment[]
  enrollments Enrollment[]   
  certificates Certificate[]
  userCoursePreviews UserCoursePreview[]
}

model Chapter {
  chapterId   String   @id @default(uuid())
  chapterName String
  totalLesson Int
  courseId    String
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  lessons Lesson[]
  chapterQuizzes ChapterQuiz[]
}

model Lesson {
  lessonId      String   @id @default(uuid())
  lessonName    String
  videoUrl      String?
  content       String?
  isPreview     Boolean  @default(false)
  chapterId     String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  chapter Chapter @relation(fields: [chapterId], references: [chapterId], onDelete: Cascade)
  submissions Submission[]
  testCodes   TestCode[]
  lessonsProgress UserLessonProgress[]
}

model TestCode {
  testCodeId      String   @id @default(uuid())
  description     String?
  input           String?
  expectedOutput  String?
  lessonId        String
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  lesson Lesson @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
}

model Comment {
  commentId  String   @id @default(uuid())
  courseId   String
  userId     String
  content    String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
}

model Notification {
  notificationId String   @id @default(uuid())
  userId         String
  type           String?
  title          String?
  message        String?
  isRead         Boolean  @default(false)
  link           String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Payment {
  paymentId            String        @id @default(uuid())
  description          String?
  currency             String?
  amount               Float
  method               String?
  paidAt               DateTime?
  userCoursePreviewId  String?
  created_at           DateTime @default(now())
  updated_at           DateTime @updatedAt

  user User? @relation(fields: [userCoursePreviewId], references: [userCoursePreviewId], onDelete: SetNull)
}

model UserCoursePreview {
  userCoursePreviewId String   @id @default(uuid())
  userId              String
  courseId            String
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  payments Payment[]
}

model Certificate {
  certificateId   String   @id @default(uuid())
  submissionId    String?   
  certificateTitle String?
  userId          String
  courseId        String
  certificateURL  String?
  issuedAt        DateTime @default(now())
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  submission Submission? @relation(fields: [submissionId], references: [submissionId], onDelete: SetNull)
}

model Submission {
  submissionId    String   @id @default(uuid())
  score           Float?
  isPassed        Boolean  @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt
  userId          String
  chapterQuizId   String?

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  chapterQuiz ChapterQuiz? @relation(fields: [chapterQuizId], references: [chapterQuizId], onDelete: Cascade)
  certificates Certificate[]
}

model ChapterQuiz {
  chapterQuizId String   @id @default(uuid())
  title         String
  description   String?
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  chapterId     String?

  chapter Chapter? @relation(fields: [chapterId], references: [chapterId], onDelete: Cascade)
  quizQuestions QuizQuestion[]
  submissions   Submission[]
}

model QuizQuestion {
  quizQuestionId String   @id @default(uuid())
  questionText   String
  questionType   String
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  chapterQuizId  String?

  chapterQuiz ChapterQuiz? @relation(fields: [chapterQuizId], references: [chapterQuizId], onDelete: Cascade)
  quizOptions  QuizOption[]
}

model QuizOption {
  quizOptionId String   @id @default(uuid())
  optionText   String
  isCorrect    Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  quizQuestionId String

  quizQuestion QuizQuestion @relation(fields: [quizQuestionId], references: [quizQuestionId], onDelete: Cascade)
}

model UserLessonProgress {
  id           String   @id @default(uuid())
  userId       String
  lessonId     String
  isCompleted  Boolean  @default(false)
  lastAccessAt DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Enrollment {
  enrollmentId String   @id @default(uuid())
  createdAt    DateTime @default(now())
  userId       String
  courseId     String

  user User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@unique([userId, courseId])
}
