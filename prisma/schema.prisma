generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Level {
  Basic
  Intermediate
  Advanced
}

enum SubLevel {
  Low
  Mid
  High
}

enum LearningSpeed {
  Slow      // Học chậm
  Normal    // Bình thường
  Fast      // Học nhanh
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  MOMO
  VNPAY
  BANK_TRANSFER
  CASH
}

model User {
  userId String @id @default(uuid()) @db.Uuid
  userName     String
  password     String
  firebaseUid  String?  @unique       // Firebase UID cho OAuth login
  email        String   @unique
  gender       Gender
  specialization String?        // Chuyên ngành của người dùng
  avatarURL    String?
  region       String?
  dateOfBirth  DateTime?
  level        Level?
  
  // ⭐ GAMIFICATION FIELDS
  experiencePoints Int @default(0)      // Tổng XP (Experience Points)
  currentLevelXP   Int @default(0)      // XP trong level hiện tại
  nextLevelXP      Int @default(100)    // XP cần để lên level tiếp theo
  totalCoursesCompleted Int @default(0) // Số khóa học đã hoàn thành
  
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  account               Account?
  roles                 UserRole[]
  roleClaims            RoleClaim[]   @relation("UserRoleClaims")
  coursesCreated        Course[]
  comments              Comment[]
  payments              Payment[]
  certificates          Certificate[]
  notifications         Notification[]
  userCoursePreviews    UserCoursePreview[]
  submissions           Submission[]
  codeSubmissions       CodeSubmission[]
  lessonsProgress       UserLessonProgress[]
  enrollments           Enrollment[]
  learningPathsCreated  LearningPath[]           // Lộ trình đã tạo
  userLearningPaths     UserLearningPath[]       // Lộ trình đang follow
  learningSpeedTracking UserLearningSpeed[]      // Tracking tốc độ học
  courseRecommendations CourseRecommendation[]   // Gợi ý khóa học
  learningSessions      LearningSession[]        // Session học
  activityLogs          ActivityLog[]            // Lịch sử hoạt động
  inactivityWarnings    InactivityWarning[]      // Cảnh báo không hoạt động
  xpTransactions        XPTransaction[]          // Lịch sử nhận XP
  achievements          UserAchievement[]        // Thành tích đạt được
  
  // Blog relations
  blogPosts             BlogPost[]               // Bài viết blog đã tạo
  blogLikes             BlogLike[]               // Bài viết đã like
  blogBookmarks         BlogBookmark[]           // Bài viết đã bookmark

  @@index([email])
  @@index([userName])
  @@index([level])
  @@index([experiencePoints])
  @@index([created_at])
}

model Account {
  id                String @id @default(uuid()) @db.Uuid
  userId            String @unique @db.Uuid
  provider          String
  providerAccountId String
  accessToken       String?
  refreshToken      String?
  expiresAt         Int?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Role {
  roleId     String @id @default(uuid()) @db.Uuid
  name       String
  userRoles  UserRole[]
  roleClaims RoleClaim[]

  @@unique([name])
}

model UserRole {
  id     String @id @default(uuid()) @db.Uuid
  userId String @db.Uuid
  roleId String @db.Uuid

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@unique([userId, roleId])
}

model RoleClaim {
  roleClaimId String @id @default(uuid()) @db.Uuid
  roleId      String? @db.Uuid
  userId      String? @unique @db.Uuid
  permission  String
  claimType   String?
  claimValue  String?

  role Role? @relation(fields: [roleId], references: [roleId], onDelete: Cascade)
  user User? @relation("UserRoleClaims", fields: [userId], references: [userId], onDelete: Cascade)
}

model Course {
  courseId          String @id @default(uuid()) @db.Uuid
  courseName        String
  courseDescription String?
  coursePrice       Float
  discount          Float?
  avatarURL         String?
  level             Level?
  subLevel          SubLevel?         // Cấp độ chi tiết: Low, Mid, High
  estimatedDuration Int?              // Thời gian ước lượng (giờ) để hoàn thành khóa học
  specialization    String?           // Chuyên ngành ví dụ CNTT, Marketing,...
  tag               String?           // tag phân loại ví dụ như C#, Excel,...
  createdBy         String? @db.Uuid
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user                  User?                  @relation(fields: [createdBy], references: [userId], onDelete: SetNull)
  chapters              Chapter[]
  comments              Comment[]
  enrollments           Enrollment[]
  certificates          Certificate[]
  userCoursePreviews    UserCoursePreview[]
  learningPathCourses   LearningPathCourse[]   // Khóa học thuộc lộ trình nào
  payments              Payment[]              // Thanh toán cho khóa học
  courseTags            CourseTag[]            // Tags của khóa học (many-to-many)

  @@index([courseName])
}

model Chapter {
  chapterId    String @id @default(uuid()) @db.Uuid
  chapterName  String
  totalLesson  Int
  courseId     String @db.Uuid
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  course         Course        @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  lessons        Lesson[]
  chapterQuizzes ChapterQuiz[]
}

model Lesson {
  lessonId       String @id @default(uuid()) @db.Uuid
  lessonName     String
  videoUrl       String?
  content        String?
  isPreview      Boolean  @default(false)
  chapterId      String @db.Uuid
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  chapter         Chapter  @relation(fields: [chapterId], references: [chapterId], onDelete: Cascade)
  testCases       TestCases[]
  lessonsProgress UserLessonProgress[]
}

model TestCases {
  testCaseId     String @id @default(uuid()) @db.Uuid
  description    String?
  input          String?
  expectedOutput String?
  lessonId       String @db.Uuid
  testCodes       String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  lesson           Lesson             @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)
  codeSubmissions  CodeSubmission[]
}

model CodeSubmission {
  submissionId     String    @id @default(uuid()) @db.Uuid
  userId           String    @db.Uuid
  testCaseId       String    @db.Uuid
  source_code      String?   
  language_id      Int?      
  stdin            String?   
  expected_output  String?   
  stdout           String?   
  stderr           String?  
  compile_output   String?   
  time             String?   
  token            String?   
  memory           Int?      
  status           Json?     
  message          String?   
  created_at       DateTime  @default(now())
  updated_at       DateTime  @updatedAt

  user             User      @relation(fields: [userId], references: [userId], onDelete: Cascade)
  testCases         TestCases  @relation(fields: [testCaseId], references: [testCaseId], onDelete: Cascade)
}

model Comment {
  commentId   String @id @default(uuid()) @db.Uuid
  courseId    String? @db.Uuid              // Optional - cho course comments
  blogPostId  String? @db.Uuid              // Optional - cho blog comments
  userId      String @db.Uuid
  content     String
  rating      Int?   @db.Integer            // Rating từ 1-5 sao (chỉ cho comment gốc)
  parentId    String? @db.Uuid              // ID của comment cha (null nếu là comment gốc)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User       @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course    Course?    @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  blogPost  BlogPost?  @relation(fields: [blogPostId], references: [blogPostId], onDelete: Cascade)
  parent    Comment?   @relation("CommentReplies", fields: [parentId], references: [commentId], onDelete: Cascade)
  replies   Comment[]  @relation("CommentReplies")

  @@index([courseId])
  @@index([blogPostId])
  @@index([userId])
  @@index([parentId])
}

model Notification {
  notificationId String @id @default(uuid()) @db.Uuid
  userId         String @db.Uuid
  type           String?
  title          String?
  message        String?
  isRead         Boolean  @default(false)
  link           String?
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt

  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model Payment {
  paymentId           String @id @default(uuid()) @db.Uuid
  description         String?
  currency            String?          // VND, USD
  amount              Float
  method              String?
  paymentMethod       PaymentMethod?
  paymentStatus       PaymentStatus @default(PENDING)
  transactionId       String?          // ID từ MoMo/VNPay
  orderInfo           String?          // Thông tin đơn hàng
  paidAt              DateTime?
  userId              String? @db.Uuid
  courseId            String? @db.Uuid
  enrollmentId        String? @db.Uuid
  userCoursePreviewId String? @db.Uuid
  metadata            Json?            // Lưu thông tin bổ sung (response từ gateway)
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  user              User?              @relation(fields: [userId], references: [userId], onDelete: SetNull)
  course            Course?            @relation(fields: [courseId], references: [courseId], onDelete: SetNull)
  enrollment        Enrollment?        @relation(fields: [enrollmentId], references: [enrollmentId], onDelete: SetNull)
  userCoursePreview UserCoursePreview? @relation(fields: [userCoursePreviewId], references: [userCoursePreviewId], onDelete: SetNull)

  @@index([transactionId])
  @@index([paymentStatus])
  @@index([courseId])
  @@index([enrollmentId])
}

model UserCoursePreview {
  userCoursePreviewId String @id @default(uuid()) @db.Uuid
  userId              String @db.Uuid
  courseId            String @db.Uuid
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  user     User    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course   Course  @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  payments Payment[]
}

model Certificate {
  certificateId    String @id @default(uuid()) @db.Uuid
  certificateTitle String?
  userId           String @db.Uuid
  courseId         String @db.Uuid
  certificateURL   String?
  averageScore     Float?         // Điểm trung bình của tất cả chapters (VD: 85.5%)
  totalScore       Float?         // Phần trăm điểm đạt được
  maxScore         Float?         // Tổng điểm tối đa có thể đạt
  issuedAt         DateTime @default(now())
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  user       User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course     Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model Submission {
  submissionId  String @id @default(uuid()) @db.Uuid
  score         Float?            // Điểm đạt được trong bài quiz này
  maxScore      Float?            // Điểm tối đa của bài quiz này (=100)
  isPassed      Boolean @default(false) // Đạt hay không 
  answers       Json?             // Lưu câu trả lời của user
  submittedAt   DateTime?         // Thời gian nộp bài
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  userId        String @db.Uuid
  chapterQuizId String @db.Uuid   

  user         User        @relation(fields: [userId], references: [userId], onDelete: Cascade)
  chapterQuiz  ChapterQuiz @relation(fields: [chapterQuizId], references: [chapterQuizId], onDelete: Cascade)

  @@unique([userId, chapterQuizId]) 
  @@index([userId])
  @@index([chapterQuizId])
  @@index([isPassed])
}

model ChapterQuiz {
  chapterQuizId String @id @default(uuid()) @db.Uuid
  title         String
  description   String?
  duration      Int?              // Thời gian làm bài (phút)
  passingScore  Float?            // Điểm đạt (%) - VD: 70.0 nghĩa là 70%
  totalPoints   Float?            // Tổng điểm tối đa của quiz này (=100)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  chapterId     String @db.Uuid   // BẮT BUỘC - không optional

  chapter       Chapter        @relation(fields: [chapterId], references: [chapterId], onDelete: Cascade)
  quizQuestions QuizQuestion[]
  submissions   Submission[]

  @@unique([chapterId])
  @@index([chapterId])
}

model QuizQuestion {
  quizQuestionId String @id @default(uuid()) @db.Uuid
  questionText   String 
  questionType   String            // multiple_choice, true_false, short_answer, essay
  points         Float @default(1.0) // Điểm của câu hỏi này
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  chapterQuizId  String @db.Uuid 

  chapterQuiz ChapterQuiz  @relation(fields: [chapterQuizId], references: [chapterQuizId], onDelete: Cascade)
  quizOptions QuizOption[]

  @@index([chapterQuizId])
}

model QuizOption {
  quizOptionId   String @id @default(uuid()) @db.Uuid
  optionText     String
  isCorrect      Boolean  @default(false)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  quizQuestionId String @db.Uuid

  quizQuestion QuizQuestion @relation(fields: [quizQuestionId], references: [quizQuestionId], onDelete: Cascade)
}

model UserLessonProgress {
  id           String @id @default(uuid()) @db.Uuid
  userId       String @db.Uuid
  lessonId     String @db.Uuid
  isCompleted  Boolean  @default(false)
  lastAccessAt DateTime?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  user   User   @relation(fields: [userId], references: [userId], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [lessonId], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Enrollment {
  enrollmentId String @id @default(uuid()) @db.Uuid
  createdAt    DateTime @default(now())
  userId       String @db.Uuid
  courseId     String @db.Uuid
  
  // ⏱️ COURSE COMPLETION TIME TRACKING
  firstAccessAt        DateTime?              // Thời điểm bắt đầu học khóa học lần đầu
  lastAccessAt         DateTime?              // Thời điểm active gần nhất (cập nhật mỗi 60s)
  completedAt          DateTime?              // Thời điểm hoàn thành khóa học (progress = 100%)
  totalCompletionTime  Int @default(0)        // Tổng thời gian (giây) từ firstAccessAt → completedAt
  isCurrentlyActive    Boolean @default(false) // User đang học hay không

  user     User      @relation(fields: [userId], references: [userId], onDelete: Cascade)
  course   Course    @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  payments Payment[] // Thanh toán liên quan đến enrollment

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@index([createdAt])
  @@index([firstAccessAt])
  @@index([completedAt])
  @@index([isCurrentlyActive])
}

// ========================================
// LEARNING PATH MODELS
// ========================================

// Lộ trình học (Template cố định do Admin/Creator tạo)
model LearningPath {
  learningPathId  String @id @default(uuid()) @db.Uuid
  title           String                     // VD: "Lộ trình Full-stack Developer"
  description     String?
  level           Level                      // Basic, Intermediate, Advanced
  estimatedHours  Int?                       // Thời gian ước tính (giờ)
  isPublished     Boolean @default(false)    // Đã public chưa
  createdBy       String? @db.Uuid
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  creator             User?                    @relation(fields: [createdBy], references: [userId], onDelete: SetNull)
  courses             LearningPathCourse[]     // Các khóa học trong lộ trình
  userLearningPaths   UserLearningPath[]       // User đang follow lộ trình này

  @@index([level])
  @@index([isPublished])
  @@index([createdBy])
}

// Các khóa học trong lộ trình (Many-to-Many giữa LearningPath và Course)
model LearningPathCourse {
  id              String @id @default(uuid()) @db.Uuid
  learningPathId  String @db.Uuid
  courseId        String @db.Uuid
  orderIndex      Int                        // Thứ tự khóa học trong lộ trình (1, 2, 3...)
  isRequired      Boolean @default(true)     // Bắt buộc hay tùy chọn
  created_at      DateTime @default(now())

  learningPath    LearningPath @relation(fields: [learningPathId], references: [learningPathId], onDelete: Cascade)
  course          Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)

  @@unique([learningPathId, courseId])
  @@index([learningPathId])
  @@index([courseId])
  @@index([orderIndex])
}

// User đang follow lộ trình nào
model UserLearningPath {
  id              String @id @default(uuid()) @db.Uuid
  userId          String @db.Uuid
  learningPathId  String @db.Uuid
  startedAt       DateTime @default(now())
  completedAt     DateTime?                  // Thời gian hoàn thành
  progress        Float @default(0)          // Tiến độ % (0-100)
  isCompleted     Boolean @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  learningPath    LearningPath @relation(fields: [learningPathId], references: [learningPathId], onDelete: Cascade)

  @@unique([userId, learningPathId])
  @@index([userId])
  @@index([learningPathId])
  @@index([isCompleted])
}

// Tracking tốc độ học của user trong từng khóa học
model UserLearningSpeed {
  id                  String @id @default(uuid()) @db.Uuid
  userId              String @db.Uuid
  courseId            String @db.Uuid
  
  // Dữ liệu để tính toán
  totalLearningTime   Int?                     // Tổng thời gian học thực tế (giờ)
  finalScore          Float?                   // Điểm cuối cùng (= totalScore từ Certificate)
  
  // Kết quả tính toán
  speedScore          Float?                   // (finalScore/100 * estimatedDuration) / totalLearningTime
  learningSpeed       LearningSpeed?           // Slow (<1), Normal (=1), Fast (>1)
  
  // Deprecated fields (giữ để backward compatibility)
  averageTimePerLesson Float?                  // Thời gian TB mỗi bài (phút)
  completionRate      Float @default(0)        // Tỷ lệ hoàn thành (%)
  quizAverageScore    Float?                   // Điểm TB các quiz
  
  lastUpdated         DateTime @default(now())
  created_at          DateTime @default(now())

  user                User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([learningSpeed])
}

// Gợi ý khóa học cho user (AI-based recommendations)
model CourseRecommendation {
  id              String @id @default(uuid()) @db.Uuid
  userId          String @db.Uuid
  recommendedCourseId String @db.Uuid
  reason          String?                    // Lý do gợi ý
  score           Float?                     // Điểm độ phù hợp (0-1)
  isViewed        Boolean @default(false)
  isEnrolled      Boolean @default(false)
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@index([userId])
  @@index([isViewed])
  @@index([isEnrolled])
}

// ========================================
// SESSION TRACKING & ACTIVITY MONITORING
// ========================================

// Session học của user (Tracking thời gian học thực tế)
model LearningSession {
  sessionId       String @id @default(uuid()) @db.Uuid
  userId          String @db.Uuid
  courseId        String @db.Uuid
  lessonId        String? @db.Uuid              // Đang học lesson nào
  
  // Thời gian
  startTime       DateTime @default(now())      // Bắt đầu session
  endTime         DateTime?                     // Kết thúc session
  totalActiveTime Int @default(0)               // Tổng thời gian active (giây)
  totalPausedTime Int @default(0)               // Tổng thời gian pause (giây)
  
  // Trạng thái
  isActive        Boolean @default(true)        // Đang active hay không
  lastActivityAt  DateTime @default(now())      // Lần tương tác cuối
  
  // Video tracking
  videoProgress   Json?                         // { lessonId: watchedSeconds }
  completedVideos Int @default(0)               // Số video đã hoàn thành
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  user                User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  activityLogs        ActivityLog[]
  inactivityWarnings  InactivityWarning[]
  
  @@index([userId])
  @@index([courseId])
  @@index([isActive])
  @@index([startTime])
}

// Lịch sử tương tác (Heartbeat tracking)
model ActivityLog {
  activityId      String @id @default(uuid()) @db.Uuid
  sessionId       String @db.Uuid
  userId          String @db.Uuid
  
  activityType    String                        // "video_start", "video_pause", "video_complete", "interaction", "idle_warning", "idle_timeout"
  timestamp       DateTime @default(now())
  metadata        Json?                         // { lessonId, videoPosition, etc }
  
  created_at      DateTime @default(now())

  session         LearningSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([userId])
  @@index([activityType])
  @@index([timestamp])
}

// Cảnh báo không hoạt động
model InactivityWarning {
  warningId       String @id @default(uuid()) @db.Uuid
  sessionId       String @db.Uuid
  userId          String @db.Uuid
  
  warningType     String                        // "video_ended", "no_interaction"
  triggeredAt     DateTime @default(now())
  respondedAt     DateTime?
  response        String?                       // "continue", "exit", "timeout"
  
  // Thời gian chờ
  waitTimeSeconds Int @default(300)             // 5 phút = 300 giây
  timeoutAt       DateTime                      // Thời điểm sẽ timeout
  
  isResolved      Boolean @default(false)
  
  created_at      DateTime @default(now())

  session         LearningSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@index([sessionId])
  @@index([userId])
  @@index([isResolved])
  @@index([triggeredAt])
}

// ========================================
// GAMIFICATION & LEVELING SYSTEM
// ========================================

// Lịch sử giao dịch XP (Experience Points)
model XPTransaction {
  transactionId   String @id @default(uuid()) @db.Uuid
  userId          String @db.Uuid
  amount          Int                           // Số XP nhận được (+) hoặc bị trừ (-)
  source          String                        // "lesson_complete", "course_complete", "quiz_pass", "achievement", "daily_login", "streak_bonus"
  description     String?                       // Mô tả chi tiết
  
  // Metadata
  courseId        String? @db.Uuid              // Liên kết đến khóa học (nếu có)
  lessonId        String? @db.Uuid              // Liên kết đến bài học (nếu có)
  achievementId   String? @db.Uuid              // Liên kết đến achievement (nếu có)
  metadata        Json?                         // Dữ liệu bổ sung
  
  created_at      DateTime @default(now())

  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@index([userId])
  @@index([source])
  @@index([created_at])
}

// Achievement/Badge system
model Achievement {
  achievementId   String @id @default(uuid()) @db.Uuid
  name            String @unique                // "First Steps", "Course Master", "Speed Learner"
  description     String                        // Mô tả achievement
  icon            String?                       // URL icon/badge
  xpReward        Int @default(0)               // XP thưởng khi đạt achievement
  
  // Điều kiện đạt achievement
  category        String                        // "course", "lesson", "quiz", "streak", "social"
  requirement     Json                          // { type: "complete_courses", count: 5 }
  
  isActive        Boolean @default(true)        // Achievement có đang active không
  rarity          String @default("common")     // "common", "rare", "epic", "legendary"
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  userAchievements UserAchievement[]
  
  @@index([category])
  @@index([isActive])
  @@index([rarity])
}

// User đã đạt những achievement nào
model UserAchievement {
  id              String @id @default(uuid()) @db.Uuid
  userId          String @db.Uuid
  achievementId   String @db.Uuid
  
  unlockedAt      DateTime @default(now())      // Thời gian mở khóa
  progress        Float @default(100)           // Tiến độ % (100 = đã hoàn thành)
  
  created_at      DateTime @default(now())

  user            User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  achievement     Achievement @relation(fields: [achievementId], references: [achievementId], onDelete: Cascade)
  
  @@unique([userId, achievementId])
  @@index([userId])
  @@index([achievementId])
  @@index([unlockedAt])
}

// Level requirements (Bảng cấu hình XP cần cho mỗi level)
model LevelRequirement {
  id              String @id @default(uuid()) @db.Uuid
  level           Level                         // Basic, Intermediate, Advanced
  minXP           Int                           // XP tối thiểu để đạt level này
  maxXP           Int?                          // XP tối đa của level (null = không giới hạn)
  title           String?                       // "Beginner", "Intermediate", "Expert"
  perks           Json?                         // Quyền lợi khi đạt level: { discount: 10, badge: "..." }
  
  created_at      DateTime @default(now())
  updated_at      DateTime @updatedAt

  @@unique([level])
  @@index([minXP])
}

// TAG & CATEGORY SYSTEM (Shared for Course & Blog)
// ========================================

// Tag chung cho cả Course và Blog (VD: nodejs, react, python, ai, etc.)
model Tag {
  tagId         String @id @default(uuid()) @db.Uuid
  name          String @unique                // "Node.js", "React", "Python"
  slug          String @unique                // "nodejs", "react", "python"
  description   String?                       // Mô tả tag
  
  // Type phân loại
  type          TagType @default(GENERAL)     // COURSE, BLOG, GENERAL
  
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  // Relations
  courseTags    CourseTag[]
  blogTags      BlogPostTag[]
  
  @@index([slug])
  @@index([type])
  @@index([name])
}

enum TagType {
  COURSE      // Chỉ dùng cho Course
  BLOG        // Chỉ dùng cho Blog
  GENERAL     // Dùng chung
}

// Category cho Blog (VD: Tutorial, News, Best Practices, etc.)
model Category {
  categoryId    String @id @default(uuid()) @db.Uuid
  name          String @unique                // "Tutorial", "News", "Best Practices"
  slug          String @unique                // "tutorial", "news", "best-practices"
  description   String?                       // Mô tả category
  
  // Hierarchy (optional - cho nested categories)
  parentId      String? @db.Uuid              // Category cha (null = root)
  orderIndex    Int @default(0)               // Thứ tự hiển thị
  
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  // Relations
  parent        Category?  @relation("CategoryHierarchy", fields: [parentId], references: [categoryId], onDelete: SetNull)
  children      Category[] @relation("CategoryHierarchy")
  blogPosts     BlogPostCategory[]
  
  @@index([slug])
  @@index([parentId])
  @@index([orderIndex])
}



// ========================================
// BLOG SYSTEM
// ========================================

// Blog Post
model BlogPost {
  blogPostId    String @id @default(uuid()) @db.Uuid
  
  // Content
  title         String                        // Tiêu đề
  slug          String @unique                // URL-friendly slug
  content       String @db.Text               // Nội dung (Markdown hoặc HTML)
  excerpt       String?                       // Tóm tắt ngắn
  coverImage    String?                       // Ảnh bìa
  
  // SEO
  metaTitle       String?                     // SEO title
  metaDescription String?                     // SEO description
  metaKeywords    String?                     // SEO keywords
  
  // Status & Publishing
  status        BlogStatus @default(DRAFT)    // DRAFT, PUBLISHED, ARCHIVED
  publishedAt   DateTime?                     // Thời gian xuất bản
  scheduledAt   DateTime?                     // Lên lịch xuất bản
  
  // Stats
  viewCount     Int @default(0)               // Lượt xem
  likeCount     Int @default(0)               // Lượt thích
  commentCount  Int @default(0)               // Số comment
  bookmarkCount Int @default(0)               // Số lượt bookmark
  shareCount    Int @default(0)               // Số lượt share
  readingTime   Int?                          // Thời gian đọc (phút)
  
  // Author
  authorId      String @db.Uuid
  
  // Featured
  isFeatured    Boolean @default(false)       // Bài viết nổi bật
  isPinned      Boolean @default(false)       // Ghim lên đầu
  
  // Timestamps
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  // Relations
  author        User              @relation(fields: [authorId], references: [userId], onDelete: Cascade)
  categories    BlogPostCategory[]
  tags          BlogPostTag[]
  comments      Comment[]         // Tái sử dụng Comment model
  likes         BlogLike[]
  bookmarks     BlogBookmark[]
  
  @@index([slug])
  @@index([authorId])
  @@index([status])
  @@index([publishedAt])
  @@index([viewCount])
  @@index([isFeatured])
  @@index([isPinned])
  @@index([created_at])
}

enum BlogStatus {
  DRAFT       // Bản nháp
  PUBLISHED   // Đã xuất bản
  ARCHIVED    // Lưu trữ
  SCHEDULED   // Đã lên lịch
}

// Many-to-Many: BlogPost <-> Category
model BlogPostCategory {
  id            String @id @default(uuid()) @db.Uuid
  blogPostId    String @db.Uuid
  categoryId    String @db.Uuid
  
  created_at    DateTime @default(now())
  
  blogPost      BlogPost @relation(fields: [blogPostId], references: [blogPostId], onDelete: Cascade)
  category      Category @relation(fields: [categoryId], references: [categoryId], onDelete: Cascade)
  
  @@unique([blogPostId, categoryId])
  @@index([blogPostId])
  @@index([categoryId])
}

// Many-to-Many: BlogPost <-> Tag
model BlogPostTag {
  id            String @id @default(uuid()) @db.Uuid
  blogPostId    String @db.Uuid
  tagId         String @db.Uuid
  
  created_at    DateTime @default(now())
  
  blogPost      BlogPost @relation(fields: [blogPostId], references: [blogPostId], onDelete: Cascade)
  tag           Tag      @relation(fields: [tagId], references: [tagId], onDelete: Cascade)
  
  @@unique([blogPostId, tagId])
  @@index([blogPostId])
  @@index([tagId])
}

// Many-to-Many: Course <-> Tag (Migration từ String sang Table)
model CourseTag {
  id            String @id @default(uuid()) @db.Uuid
  courseId      String @db.Uuid
  tagId         String @db.Uuid
  
  created_at    DateTime @default(now())
  
  course        Course @relation(fields: [courseId], references: [courseId], onDelete: Cascade)
  tag           Tag    @relation(fields: [tagId], references: [tagId], onDelete: Cascade)
  
  @@unique([courseId, tagId])
  @@index([courseId])
  @@index([tagId])
}

// Blog Likes
model BlogLike {
  id            String @id @default(uuid()) @db.Uuid
  blogPostId    String @db.Uuid
  userId        String @db.Uuid
  
  created_at    DateTime @default(now())
  
  blogPost      BlogPost @relation(fields: [blogPostId], references: [blogPostId], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@unique([blogPostId, userId])
  @@index([blogPostId])
  @@index([userId])
}

// Blog Bookmarks
model BlogBookmark {
  id            String @id @default(uuid()) @db.Uuid
  blogPostId    String @db.Uuid
  userId        String @db.Uuid
  
  note          String?                       // Ghi chú cá nhân
  
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  blogPost      BlogPost @relation(fields: [blogPostId], references: [blogPostId], onDelete: Cascade)
  user          User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
  
  @@unique([blogPostId, userId])
  @@index([blogPostId])
  @@index([userId])
}
